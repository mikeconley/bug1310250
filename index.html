<!DOCTYPE html>
<html>
<head>
<title> Tab Spinners - Bug 1310250</title>
<script src="https://telemetry.mozilla.org/v2/telemetry.js"></script>

<!-- MG.js stuff -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="mgjs/metricsgraphics.min.js"></script>
<link href="mgjs/metricsgraphics.css" rel="stylesheet" type="text/css">

<style>
.plot-container {
  height: 30vh;
  width: 95vw;
}

#severity {
  height: 40vh;
}

.centered {
  padding-top: 1em;
  border-top: 1px solid #999999;
  text-align: center;
}
</style>
</head>
<body>
<h1>Nightly 51+, Windows only</h1>
<div id="proportions" class="plot-container">
</div>
<div id="times" class="plot-container">
</div>
<div id="spinners" class="plot-container">
</div>
<div id="switches" class="plot-container">
</div>
<p class="centered">
  The graphs below do not line up, date-wise, with the graphs above.
</p>
<div id="affected" class="plot-container">
</div>
<div id="severity" class="plot-container">
</div>
<div id="severity-legend"></div>

<div id="notes">
<p><b>Notes:</b></p>
<ul>
<li>Spinner counts, durations are from FX_TAB_SWITCH_SPINNER_VISIBLE_MS</li>
<li>Switch counts, durations are from FX_TAB_SWITCH_TOTAL_E10S_MS</li>
<li>Only clients with e10s on are considered</li>
<li>These plots start at Nightly 51 and continue to present day, on Nightly</li>
</ul>
</div>
<script>
const TAB_SPINNER = "FX_TAB_SWITCH_SPINNER_VISIBLE_MS";
const TAB_SWITCH = "FX_TAB_SWITCH_TOTAL_E10S_MS";
const SEVERITY_DATA_URL = "https://s3-us-west-2.amazonaws.com/telemetry-public-analysis-2/spinner-severity-generator/data/severities_by_build_id.json"

Telemetry.init(() => {
  let rawVersions = Telemetry.getVersions("nightly/51", "nightly/A");
  let versions = rawVersions.map(version => version.split("/"));
  let data = {};
  Promise.all(versions.map(([channel, version]) => new Promise((resolve, reject) => {
    Telemetry.getEvolution(channel, version, TAB_SPINNER, {os: ["Windows_NT"], e10sEnabled: "true"}, false /* useSubmissionDate */, evolutionMap => {
      if (!("" in evolutionMap) || !evolutionMap[""]) {
        console.error(`Failed to get tab spinner data for ${channel}/${version}`);
        reject();
        return;
      }
      let ev = evolutionMap[""].sanitized();
      ev.map((hgram, i, date) => {
        if (!(date in data)) {
          data[date] = {
            date: date,
            spinners: hgram.count,
            spinnersSum: hgram.sum,
            switches: 0,
            switchesSum: 0,
          };
        } else {
          data[date].spinners += hgram.count;
          data[date].spinnersSum += hgram.sum;
        }
      });

      resolve();
    });
  }))).then(() => {
    Promise.all(versions.map(([channel, version]) => new Promise((resolve, reject) => {
      Telemetry.getEvolution(channel, version, TAB_SWITCH, {e10sEnabled: "true"}, false /* useSubmissionDate */, evolutionMap => {
        if (!("" in evolutionMap) || !evolutionMap[""]) {
          console.error(`Failed to get tab switch data for ${channel}/${version}`);
          reject();
          return;
        }
        let ev = evolutionMap[""].sanitized();
        ev.map((hgram, i, date) => {
          if (!(date in data)) {
            data[date] = {
              date: date,
              spinners: 0,
              spinnsersSum: 0,
              switches: hgram.count,
              switchesSum: hgram.sum,
            };
          } else {
            data[date].switches += hgram.count;
            data[date].switchesSum += hgram.sum;
          }
        });

        resolve();
      });
    }))).then(() => {
      let dataArray = Object.keys(data).map(date => {
        return {
          date: new Date(date),
          spinners: data[date].spinners,
          switches: data[date].switches,
          proportions: 1.0 * data[date].spinners / data[date].switches,
          times: 1.0 * data[date].spinnersSum / data[date].switchesSum,
        };
      });
      const PLOT_TITLES = {
        spinners: "Number of Tab Spinners",
        switches: "Number of Tab Switches",
        proportions: "What % of Tab Switches see Spinners?",
        times: "What % of Total Switch time is Spinner time?",
      };
      ['spinners', 'switches', 'proportions', 'times'].forEach(plot => {
        MG.data_graphic({
          title: PLOT_TITLES[plot],
          data: dataArray,
          full_width: true,
          full_height: true,
          show_tooltips: false,
          target: "#" + plot,
          y_accessor: plot,
          format: ['proportions', 'times'].includes(plot) ? 'percentage' : 'count',
          //legend: LINES,
          //legend_target: "#none",
          utc_time: true,
          buffer: 0,
          interpolate: d3.curveLinear,
        });
      });
    });
  });
});


fetch(SEVERITY_DATA_URL).then((response) => {
  return response.json();
}).then((data) => {
  console.log("Got severity data. Converting into something useful...");

  let yyyymmdd_to_date = (yyyymmdd) => {
    let y = yyyymmdd.substr(0,4),
        m = yyyymmdd.substr(4,2) - 1,
        d = yyyymmdd.substr(6,2);
    let D = new Date(y, m, d);
    return (D.getFullYear() == y && D.getMonth() == m && D.getDate() == d) ? D : 'invalid date';
  };

  // First, let's transform the data so that MG can use it for the affected graph.
  let prepared_data = data.map((element) => {
    let date = yyyymmdd_to_date(element[0]);
    let severities = element[1];
    let affected = 1.0 - severities[0];
    return {
      date,
      affected,
    }
  });

  // The first plot is "affected", so take 1.0, subtract the unaffected, and
  // there you have it.
  MG.data_graphic({
    title: "Affected client %",
    data: prepared_data,
    full_width: true,
    full_height: true,
    show_tooltips: false,
    target: "#affected",
    y_accessor: "affected",
    format: "percentage",
    //legend: LINES,
    //legend_target: "#none",
    utc_time: true,
    buffer: 0,
    interpolate: d3.curveLinear,
  });

  // Now transform the data for our multi-line plot for severities.
  const LABELS = [
    "unaffected",
    "1ms - 999ms",
    "1000ms - 2296ms",
    "2297ms - 5276ms",
    "5277ms - 12123ms",
    "12124ms - 27855ms",
    "27856ms - 63999ms",
    "64000ms+",
  ];

  let all_severities = [];
  for (let i = 0; i < data.length; ++i) {
    let build_data = data[i];
    let date = yyyymmdd_to_date(build_data[0]);
    let build_severities = build_data[1];
    for (let j = 0; j < build_severities.length; ++j) {
      if (!all_severities[j]) {
        all_severities[j] = [];
      }

      all_severities[j].push({
        date,
        value: build_severities[j],
      });
    }
  }

  // Now get rid of unaffected, since we don't care about it.
  all_severities.shift();
  let legend = LABELS.concat();
  legend.shift();

  MG.data_graphic({
    title: "Severity",
    description: "This line chart contains multiple lines.",
    data: all_severities,
    show_tooltips: false,
    full_width: true,
    full_height: true,
    target: '#severity',
    colors: ["green", "blue", "orange", "red", "darkred", "orange", "black"],
    legend,
    legend_target: '#severity-legend',
  });
});

</script>
</body>
</html>
